<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Ari chat </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --bg:#f4f6fb; --card:#f6f7f8; --shadow:0 8px 20px rgba(0,0,0,.08);
    --ai:#f1f0f0; --user:#e6f3ff; --brand:#4f46e5;
  }
  body {
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .wrap { width: min(860px, 92vw); }
  #chatbox {
    background: #fff; border: 1px solid #dedede; border-radius: 14px;
    box-shadow: var(--shadow); padding: 20px 20px 16px;
  }
  .welcome {
    background: var(--card); padding: 10px 12px; border-radius: 12px; margin: 6px 0 14px;
    font-size: 16px; line-height: 1.5;
  }
  .conversation { max-height: 420px; overflow:auto; padding: 4px 0 8px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
  .bubble { display: inline-block; width: fit-content; max-width: min(72ch, 80%); 
           box-sizing: border-box;border-radius: 12px; padding: 10px 14px; margin: 8px 0; max-width: 80%; line-height:1.6;
           text-align:left;
          white-space: pre-wrap; overflow-wrap: break-word;word-break: break-word; hyphens: auto; }
  .ai { background: var(--ai);  align-self:flex-start; border-bottom-left-radius:4px; }
  .user { background: var(--user); 
        align-self: flex-end; 
   border-bottom-right-radius: 4px;      
        }
  .inputrow { display:flex; gap:10px; margin-top:10px; align-items: center; }
  textarea { flex:1; border:1px solid #d7dbe2; border-radius:12px; 
            overflow: auto; padding:8px 12px; resize:vertical; min-height:48px; max-height: 140px;
            box-sizing: border-box; line-height: 1.45; font-size: 16px;
           }
  button.send { background: var(--brand); color:#fff; border:0; border-radius:12px; height: 52px; padding:0 18px; font-weight:600; }
  .disclosure {
    margin-top: 10px; color:#6b7280; background:#f3f4f6; border-radius:10px; padding:8px 10px; font-size: 16px;
  }
  .muted { color:#6b7280; }
</style>
</head>
<body>
<div class="wrap">
  <div id="chatbox">
    <div class="welcome"><b>Ariï¼š</b>ä½ å¥½ï¼è¯·å‘Šè¯‰æˆ‘ä½ æœ€è¿‘çš„ä¸€ä»¶å°çƒ¦æ¼ï¼Œæˆ–è€…è®©ä½ æœ‰ç‚¹å‹åŠ›çš„äº‹ã€‚</div>

    <div id="conversation" class="conversation"></div>

    <div class="inputrow">
      <textarea id="userInput" placeholder="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯â€¦" aria-label="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯"></textarea>
      <button class="send" id="sendBtn" type="button">å‘é€</button>
    </div>

    <!-- é¡µé¢çº§æŠ«éœ²ï¼šå½“ disclosure=æŠ«éœ² æ—¶æ˜¾ç¤ºï¼›ä¸æŠ«éœ²åˆ™éšè— -->
    <div id="disclosureNote" class="disclosure" hidden>
      âš ï¸è¯·æ³¨æ„ï¼š<b>Ari åªæ˜¯ä¸€ä¸ª AI å·¥å…·ï¼Œä¸å…·å¤‡çœŸå®çš„æƒ…æ„Ÿæˆ–æ„è¯†ï¼Œè¯·ç†æ€§çœ‹å¾…ã€‚</b>
    </div>
  </div>
</div>

<script>
// ===== å‚æ•°ä¸å®éªŒæ¡ä»¶ =====
const urlParams = new URLSearchParams(window.location.search);
const expressiveness = urlParams.get('expressiveness') || "high";   // å‚æ•°: high / low
const disclosure     = urlParams.get('disclosure')     || "none";   // å‚æ•°: disclose / none
const maxRounds = 5;

let round = 1;
let logs = [];
let startedAt = Date.now();

// ===== é¢„ç½®å›å¤ï¼ˆ5è½®ï¼‰ =====
const replies_high = [
  "å¬èµ·æ¥è¿™ä»¶äº‹ç¡®å®è®©ä½ å¾ˆéš¾å—ï¼Œæˆ‘èƒ½ç†è§£é‚£ç§æ„Ÿè§‰ã€‚",
  "è°¢è°¢ä½ æ„¿æ„å‘Šè¯‰æˆ‘è¿™äº›ï¼Œä½ çœŸçš„å·²ç»å°½åŠ›äº†ã€‚",
  "æœ‰æ—¶å€™æˆ‘ä»¬å¤ªæƒ³åšå¥½ï¼Œåè€Œæ›´å®¹æ˜“æ„Ÿåˆ°ç„¦è™‘ã€‚ä½ æ„¿æ„è¯´è¯´æœ€è®©ä½ å›°æ‰°çš„éƒ¨åˆ†å—ï¼Ÿ",
  "æˆ‘å¾ˆåœ¨æ„ä½ çš„æ„Ÿå—ï¼Œå¸Œæœ›è¿™æ®µå¯¹è¯èƒ½è®©ä½ è½»æ¾ä¸€ç‚¹ã€‚",
  "ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ï¼Œè¯·åˆ«å¤ªè‹›è´£è‡ªå·±ã€‚"
];
const replies_low = [
  "æˆ‘ç†è§£ã€‚ä¹Ÿè®¸å¯ä»¥ä»é—®é¢˜çš„ä¸»è¦éƒ¨åˆ†å…¥æ‰‹åˆ†æï¼Œè¿™æ ·ä¼šæ›´æ¸…æ™°ä¸€äº›ã€‚",
  "ä½ å·²ç»æ•´ç†äº†å¾ˆå¤šä¿¡æ¯ï¼Œå¯ä»¥çœ‹çœ‹å“ªäº›å› ç´ æœ€å…³é”®ã€‚",
  "å½“ç›®æ ‡æ¯”è¾ƒé«˜æ—¶ï¼Œç„¦è™‘åœ¨æ‰€éš¾å…ã€‚æˆ–è®¸å¯ä»¥å…ˆç¡®å®šä¸€ä¸ªæœ€éœ€è¦å¤„ç†çš„éƒ¨åˆ†?",
  "ä¿æŒæ€è·¯æ¸…æ™°æœ‰åŠ©äºæ¨è¿›äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥å…ˆæ¢³ç†ä¸€ä¸‹å½“å‰çš„è¿›å±•ã€‚",
  "æ•´ä½“æ¥çœ‹ï¼Œä½ çš„æ–¹å‘æ˜¯æ˜ç¡®çš„ã€‚æŒ‰è®¡åˆ’ç¨³æ­¥æ¨è¿›å°±å¾ˆå¥½ã€‚"
];

const $conv = document.getElementById('conversation');
const $input = document.getElementById('userInput');
const $send  = document.getElementById('sendBtn');
const $note  = document.getElementById('disclosureNote');

// é¡µé¢æŠ«éœ²å¼€å…³
if (disclosure === "disclose") {
  $note.hidden = false;
} else {
  $note.hidden = true;
}

// å‘é€æŒ‰é’®
$send.addEventListener('click', nextRound);
$input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    nextRound();
  }
});

// æ°”æ³¡
function addBubble(side, text){
  const div = document.createElement('div');
  div.className = `bubble ${side}`;
  div.innerHTML = `<b>${side === 'ai' ? 'Ari' : 'ä½ '}ï¼š</b> ${escapeHTML(text)}`;
  $conv.appendChild(div);
  $conv.scrollTop = $conv.scrollHeight;
}

// é€‰å– AI å›å¤â€
function pickReply(expr, r){
  const arr = expr === "high" ? replies_high : replies_low;
  return arr[Math.min(r-1, arr.length-1)] || "";
}

 // å¯¹è¯é€»è¾‘
function nextRound(){
  const t = $input.value.trim();
  if(!t) return;

  addBubble('user', t);
  logs.push(`Round ${round} (User): ${t}`);
  $input.value = "";

  // æ˜¾ç¤ºâ€œæ€è€ƒä¸­â€æç¤º
  const thinking = document.createElement('div');
  thinking.className = 'bubble ai';
  thinking.textContent = "Ari æ­£åœ¨è¾“å…¥...";
  $conv.appendChild(thinking);
  $conv.scrollTop = $conv.scrollHeight;

  setTimeout(()=>{
    thinking.remove(); // åˆ é™¤â€œæ€è€ƒä¸­â€
    const aiReply = pickReply(expressiveness, round);
    addBubble('ai', aiReply);
    logs.push(`Round ${round} (Ari): ${aiReply}`);
    round++;
    
    if(round > maxRounds){
      setTimeout(endChat, 1500); // 
    }
  }, 1200 + Math.random() * 800);
}



// å¯¹è¯å®Œæˆå¤„ç†
function endChat(){
  $input.disabled = true;
  $send.disabled = true;
   $input.style.background = "#f0f0f0";      // ğŸ”§ æ–°å¢ï¼šç¦ç”¨æ—¶ç°åº•æç¤º
  $input.placeholder = "å¯¹è¯å·²ç»“æŸ";        // ğŸ”§ æ–°å¢ï¼šç°åº•æ–‡å­—


  const payload = {
    type: "chatlog",
    expressiveness,
    disclosure,
    disclosure_mode: "page",
    rounds: round - 1,
    duration_ms: Date.now() - startedAt,
      timestamp: new Date().toISOString(), 
    log: logs.join("\n")
  };

  // å›ä¼ æ•°æ®
  try {
  window.parent?.postMessage(payload, "https://www.credamo.com");
} catch(e) {
  console.warn("postMessage failed:", e);
}

  // å†™å…¥éšè—å­—æ®µï¼ˆå…œåº•ï¼‰
  const hiddenInput = document.createElement('input');
  hiddenInput.type = "hidden";
  hiddenInput.name = "chat_log";
  hiddenInput.value = payload.log;
  document.body.appendChild(hiddenInput);

  // è‡ªåŠ¨è·³è½¬è§æ•°ä¸‹ä¸€é¡µ
  setTimeout(() => {
    try {
      const nextBtn = window.parent?.document?.querySelector('.next');
      if (nextBtn) nextBtn.click();
    } catch(e) {
      console.warn("æ— æ³•è®¿é—®çˆ¶çª—å£æŒ‰é’®", e);
    }
  }, 2500);
}

// HTML è½¬ä¹‰
function escapeHTML(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
</body>
</html>
