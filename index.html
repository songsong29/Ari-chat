<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Ari chat </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --bg:#f4f6fb; --card:#f6f7f8; --shadow:0 8px 20px rgba(0,0,0,.08);
    --ai:#f1f0f0; --user:#e6f3ff; --brand:#4f46e5;
  }
  body {
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .wrap { width: min(860px, 92vw); }
  #chatbox {
    background: #fff; border: 1px solid #dedede; border-radius: 14px;
    box-shadow: var(--shadow); padding: 20px 20px 16px;
  }
  .welcome {
    background: var(--card); padding: 10px 12px; border-radius: 12px; margin: 6px 0 14px;
    font-size: 16px; line-height: 1.5;
  }
  .conversation { max-height: 420px; overflow:auto; padding: 4px 0 8px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
  .bubble { display: inline-block; width: fit-content; max-width: min(72ch, 80%); 
           box-sizing: border-box;border-radius: 12px; padding: 10px 14px; margin: 8px 0; max-width: 80%; line-height:1.6;
           text-align:left;
          white-space: pre-wrap; overflow-wrap: break-word;word-break: break-word; hyphens: auto; }
  .ai { background: var(--ai);  align-self:flex-start; border-bottom-left-radius:4px; }
  .user { background: var(--user); 
        align-self: flex-end; 
   border-bottom-right-radius: 4px;      
        }
  .inputrow { display:flex; gap:10px; margin-top:10px; align-items: center; }
  textarea { flex:1; border:1px solid #d7dbe2; border-radius:12px; 
            overflow: auto; padding:8px 12px; resize:vertical; min-height:48px; max-height: 140px;
            box-sizing: border-box; line-height: 1.45; font-size: 16px;
           }
  button.send { background: var(--brand); color:#fff; border:0; border-radius:12px; height: 52px; padding:0 18px; font-weight:600; }
  .disclosure {
    margin-top: 10px; color:#6b7280; background:#f3f4f6; border-radius:10px; padding:8px 10px; font-size: 16px;
  }
  .muted { color:#6b7280; }
</style>
</head>
<body>
<div class="wrap">
  <div id="chatbox">
    <div class="welcome"><b>Ariï¼š</b>ä½ å¥½ï¼è¯·å‘Šè¯‰æˆ‘ä½ æœ€è¿‘çš„ä¸€ä»¶å°çƒ¦æ¼ï¼Œæˆ–è€…è®©ä½ æœ‰ç‚¹å‹åŠ›çš„äº‹ã€‚</div>

    <div id="conversation" class="conversation"></div>

    <div class="inputrow">
      <textarea id="userInput" placeholder="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯â€¦" aria-label="è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯"></textarea>
      <button class="send" id="sendBtn" type="button">å‘é€</button>
    </div>

    <!-- é¡µé¢çº§æŠ«éœ²ï¼šå½“ disclosure=æŠ«éœ² æ—¶æ˜¾ç¤ºï¼›ä¸æŠ«éœ²åˆ™éšè— -->
    <div id="disclosureNote" class="disclosure" hidden>
      âš ï¸è¯·æ³¨æ„ï¼š<b>Ari åªæ˜¯ä¸€ä¸ª AI å·¥å…·ï¼Œä¸å…·å¤‡çœŸå®çš„æƒ…æ„Ÿæˆ–æ„è¯†ï¼Œè¯·ç†æ€§çœ‹å¾…ã€‚</b>
    </div>
  </div>
</div>

<script>
// ===== å‚æ•°ä¸å®éªŒæ¡ä»¶ =====
const urlParams = new URLSearchParams(window.location.search);
const expressiveness = urlParams.get('expressiveness') || "high";   // å‚æ•°: high / low
const disclosure     = urlParams.get('disclosure')     || "none";   // å‚æ•°: disclose / none
const maxRounds = 5;

let round = 1;
let logs = [];
let startedAt = Date.now();

// ===== é¢„ç½®å›å¤ï¼ˆ5è½®ï¼‰ =====
const replies_high = [
  "å¬èµ·æ¥é‚£ç¡®å®ä¸å®¹æ˜“å‘¢ï¼Œæˆ‘èƒ½æ„Ÿå—åˆ°ä½ çš„è¾›è‹¦ã€‚",
  "è°¢è°¢ä½ æ„¿æ„å’Œæˆ‘è¯´è¿™äº›ï¼Œæˆ‘è§‰å¾—ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ã€‚",
  "æˆ–è®¸å¯ä»¥è®©è‡ªå·±ç¨å¾®æ”¾æ¾ä¸€ä¸‹ï¼Œåšç‚¹è®©å¿ƒæƒ…èˆ’æœçš„å°äº‹ï¼Ÿ",
  "æœ‰æ—¶å€™æƒ…ç»ªèµ·ä¼æ˜¯æ­£å¸¸çš„ï¼Œä½ ä¸éœ€è¦æ€»æ˜¯è¡¨ç°å¾—åšå¼ºã€‚",
  "æˆ‘å¸Œæœ›è¿™æ®µå¯¹è¯èƒ½è®©ä½ æ„Ÿåˆ°è¢«ç†è§£ï¼Œä½ å¹¶ä¸å­¤å•ã€‚"
];
const replies_low = [
  "æˆ‘æ˜ç™½ã€‚è¿™ç§æƒ…å†µå¯ä»¥è€ƒè™‘å…·ä½“åœ°æ¢³ç†é—®é¢˜ã€‚",
  "ä½ å¯ä»¥å°è¯•å†™ä¸‹é—®é¢˜çš„æ¥æºï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ›´æ¸…æ™°çš„æ–¹å‘ã€‚",
  "ä¹Ÿè®¸åˆ¶å®šä¸€ä¸ªç®€å•çš„è®¡åˆ’ä¼šæœ‰å¸®åŠ©ï¼Œæ¯”å¦‚ä»å°ç›®æ ‡å¼€å§‹ã€‚",
  "ä½ å¯ä»¥ç”¨è®°å½•çš„æ–¹å¼è¿½è¸ªè¿›å±•ï¼Œè¿™æ ·ä¼šæ›´æœ‰æŒæ§æ„Ÿã€‚",
  "è¯·æ³¨æ„åˆç†å®‰æ’ç²¾åŠ›ï¼Œå¾ªåºæ¸è¿›åœ°åº”å¯¹æŒ‘æˆ˜ã€‚"
];

const $conv = document.getElementById('conversation');
const $input = document.getElementById('userInput');
const $send  = document.getElementById('sendBtn');
const $note  = document.getElementById('disclosureNote');

// é¡µé¢æŠ«éœ²å¼€å…³
if (disclosure === "disclose") {
  $note.hidden = false;
} else {
  $note.hidden = true;
}

// å‘é€æŒ‰é’®
$send.addEventListener('click', nextRound);
$input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    nextRound();
  }
});

// æ°”æ³¡
function addBubble(side, text){
  const div = document.createElement('div');
  div.className = `bubble ${side}`;
  div.innerHTML = `<b>${side === 'ai' ? 'Ari' : 'ä½ '}ï¼š</b> ${escapeHTML(text)}`;
  $conv.appendChild(div);
  $conv.scrollTop = $conv.scrollHeight;
}

// é€‰å– AI å›å¤â€
function pickReply(expr, r){
  const arr = expr === "high" ? replies_high : replies_low;
  return arr[Math.min(r-1, arr.length-1)] || "";
}

 // å¯¹è¯é€»è¾‘
function nextRound(){
  const t = $input.value.trim();
  if(!t) return;

  addBubble('user', t);
  logs.push(`Round ${round} (User): ${t}`);
  $input.value = "";

  // æ˜¾ç¤ºâ€œæ€è€ƒä¸­â€æç¤º
  const thinking = document.createElement('div');
  thinking.className = 'bubble ai';
  thinking.textContent = "Ari æ­£åœ¨è¾“å…¥...";
  $conv.appendChild(thinking);
  $conv.scrollTop = $conv.scrollHeight;

  setTimeout(()=>{
    thinking.remove(); // åˆ é™¤â€œæ€è€ƒä¸­â€
    const aiReply = pickReply(expressiveness, round);
    addBubble('ai', aiReply);
    logs.push(`Round ${round} (Ari): ${aiReply}`);
    round++;
    
   if(round > maxRounds){
      // ğŸ”§ å¢åŠ æ¸©æŸ”ç»“æŸè¯­
      setTimeout(()=>{
        addBubble('ai', "è°¢è°¢ä½ å’Œæˆ‘èŠåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç»§ç»­é—®å·å§ã€‚");
        setTimeout(endChat, 2000);
      }, 1000);
    }
  }, 1200 + Math.random() * 800); // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´ 1.2â€“2ç§’
}



// å¯¹è¯å®Œæˆå¤„ç†
function endChat(){
  $input.disabled = true;
  $send.disabled = true;
   $input.style.background = "#f0f0f0";      // ğŸ”§ æ–°å¢ï¼šç¦ç”¨æ—¶ç°åº•æç¤º
  $input.placeholder = "å¯¹è¯å·²ç»“æŸ";        // ğŸ”§ æ–°å¢ï¼šç°åº•æ–‡å­—


  const payload = {
    type: "chatlog",
    expressiveness,
    disclosure,
    disclosure_mode: "page",
    rounds: round - 1,
    duration_ms: Date.now() - startedAt,
      timestamp: new Date().toISOString(), 
    log: logs.join("\n")
  };

  // å›ä¼ æ•°æ®
  try {
  window.parent?.postMessage(payload, "https://www.credamo.com");
} catch(e) {
  console.warn("postMessage failed:", e);
}

  // å†™å…¥éšè—å­—æ®µï¼ˆå…œåº•ï¼‰
  const hiddenInput = document.createElement('input');
  hiddenInput.type = "hidden";
  hiddenInput.name = "chat_log";
  hiddenInput.value = payload.log;
  document.body.appendChild(hiddenInput);

  // è‡ªåŠ¨è·³è½¬è§æ•°ä¸‹ä¸€é¡µ
  setTimeout(() => {
    try {
      const nextBtn = window.parent?.document?.querySelector('.next');
      if (nextBtn) nextBtn.click();
    } catch(e) {
      console.warn("æ— æ³•è®¿é—®çˆ¶çª—å£æŒ‰é’®", e);
    }
  }, 2500);
}

// HTML è½¬ä¹‰
function escapeHTML(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
</body>
</html>
