<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Ari chat </title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --bg:#f4f6fb; --card:#f6f7f8; --shadow:0 8px 20px rgba(0,0,0,.08);
    --ai:#f1f0f0; --user:#e6f3ff; --brand:#4f46e5;
  }
  body {
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    background: var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .wrap { width: min(860px, 92vw); }
  #chatbox {
    background: #fff; border: 1px solid #dedede; border-radius: 14px;
    box-shadow: var(--shadow); padding: 20px 20px 16px;
  }
  .welcome {
    background: var(--card); padding: 10px 12px; border-radius: 12px; margin: 6px 0 14px;
    font-size: 16px; line-height: 1.5;
  }
  .conversation { max-height: 420px; overflow:auto; padding: 4px 0 8px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
  .bubble { display: inline-block; width: fit-content; max-width: min(72ch, 80%); 
           box-sizing: border-box;border-radius: 12px; padding: 10px 14px; margin: 8px 0; max-width: 80%; line-height:1.6;
           text-align:left;
          white-space: pre-wrap; overflow-wrap: break-word;word-break: break-word; hyphens: auto; }
  .ai { background: var(--ai);  align-self:flex-start; border-bottom-left-radius:4px; }
  .user { background: var(--user); 
        align-self: flex-end; 
   border-bottom-right-radius: 4px;      
        }
  .inputrow { display:flex; gap:10px; margin-top:10px; align-items: center; }
  textarea { flex:1; border:1px solid #d7dbe2; border-radius:12px; 
            overflow: auto; padding:8px 12px; resize:vertical; min-height:48px; max-height: 140px;
            box-sizing: border-box; line-height: 1.45; font-size: 16px;
           }
  button.send { background: var(--brand); color:#fff; border:0; border-radius:12px; height: 52px; padding:0 18px; font-weight:600; }
  .disclosure {
    margin-top: 10px; color:#6b7280; background:#f3f4f6; border-radius:10px; padding:8px 10px; font-size: 16px;
  }
  .muted { color:#6b7280; }
</style>
</head>
<body>
<div class="wrap">
  <div id="chatbox">
    <div class="welcome"><b>Ari：</b>你好！请告诉我你最近的一件小烦恼，或者让你有点压力的事。</div>

    <div id="conversation" class="conversation"></div>

    <div class="inputrow">
      <textarea id="userInput" placeholder="请输入你的消息…" aria-label="请输入你的消息"></textarea>
      <button class="send" id="sendBtn" type="button">发送</button>
    </div>

    <!-- 页面级披露：当 disclosure=披露 时显示；不披露则隐藏 -->
    <div id="disclosureNote" class="disclosure" hidden>
      ⚠️请注意：<b>Ari 只是一个 AI 工具，不具备真实的情感或意识，请理性看待。</b>
    </div>
  </div>
</div>

<script>
// ===== 参数与实验条件 =====
const urlParams = new URLSearchParams(window.location.search);
const expressiveness = urlParams.get('expressiveness') || "high";   // 参数: high / low
const disclosure     = urlParams.get('disclosure')     || "none";   // 参数: disclose / none
const maxRounds = 5;

let round = 1;
let logs = [];
let startedAt = Date.now();

// ===== 预置回复（5轮） =====
const replies_high = [
  "听起来这件事确实让你很难受，我能理解那种感觉。",
  "有时候我们太想做好，反而更容易感到焦虑。你愿意说说最让你困扰的部分吗？",
  "谢谢你愿意告诉我这些，你真的已经尽力了。",
  "我很在意你的感受，希望这段对话能让你轻松一点。",
  "你已经做得很好了，请别太苛责自己。"
];
const replies_low = [
  "我理解。或许可以从问题的主要部分入手分析，这样会更清晰一些。",
  "当目标比较高时，焦虑在所难免。或许可以先确定一个最需要处理的部分？",
  "你已经整理了很多信息，可以看看哪些因素最关键。",
  "也许我们可以一起整理一下思路，看看有哪些可行的方向。",
  "整体来看，你的条理是明确的。稳步推进就很好。"
];
const $conv = document.getElementById('conversation');
const $input = document.getElementById('userInput');
const $send  = document.getElementById('sendBtn');
const $note  = document.getElementById('disclosureNote');

// 页面披露开关
if (disclosure === "disclose") {
  $note.hidden = false;
} else {
  $note.hidden = true;
}

// 发送按钮
$send.addEventListener('click', nextRound);
$input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    nextRound();
  }
});

// 气泡
function addBubble(side, text){
  const div = document.createElement('div');
  div.className = `bubble ${side}`;
  div.innerHTML = `<b>${side === 'ai' ? 'Ari' : '你'}：</b> ${escapeHTML(text)}`;
  $conv.appendChild(div);
  $conv.scrollTop = $conv.scrollHeight;
}

// 选取 AI 回复”
function pickReply(expr, r){
  const arr = expr === "high" ? replies_high : replies_low;
  return arr[Math.min(r-1, arr.length-1)] || "";
}

 // 对话逻辑
function nextRound(){
  const t = $input.value.trim();
  if(!t) return;

  addBubble('user', t);
  logs.push(`Round ${round} (User): ${t}`);
  $input.value = "";

  // 显示“思考中”提示
  const thinking = document.createElement('div');
  thinking.className = 'bubble ai';
  thinking.textContent = "Ari 正在输入...";
  $conv.appendChild(thinking);
  $conv.scrollTop = $conv.scrollHeight;

  setTimeout(()=>{
    thinking.remove(); // 删除“思考中”
    const aiReply = pickReply(expressiveness, round);
    addBubble('ai', aiReply);
    logs.push(`Round ${round} (Ari): ${aiReply}`);
    round++;
    
    if(round > maxRounds){
      setTimeout(endChat, 1500); // 
    }
  }, 1200 + Math.random() * 800);
}



// 对话完成处理
function endChat(){
  $input.disabled = true;
  $send.disabled = true;
  $input.style.background = "#f0f0f0";
  $input.placeholder = "对话已结束";

  const payload = {
    type: "chatlog",
    expressiveness,
    disclosure,
    disclosure_mode: "page",
    rounds: round - 1,
    duration_ms: Date.now() - startedAt,
    timestamp: new Date().toISOString(),
    log: logs.join("\n")
  };

  try {
    window.parent?.postMessage(payload, "https://www.credamo.com");
  } catch(e) {
    console.warn("postMessage failed:", e);
  }

  // ✅ 保底写入隐藏字段
  const hiddenInput = document.createElement('input');
  hiddenInput.type = "hidden";
  hiddenInput.name = "chat_log";
  hiddenInput.value = payload.log;
  document.body.appendChild(hiddenInput);

  setTimeout(() => {
    try {
      const nextBtn = window.parent?.document?.querySelector('.next');
      if (nextBtn) nextBtn.click();
      else alert("请点击“下一步”继续问卷。");
    } catch(e) {
      alert("请点击“下一步”继续问卷。");
    }
  }, 2000);
}

function escapeHTML(s){
  return s.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

// ✅ 调试辅助：若报错则打印
window.addEventListener('error', (e) => {
  console.error("JavaScript error:", e.message);
});
</script>
</body>
</html>
